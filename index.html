<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>加法表 & 加減法練習</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

  <!-- 自訂樣式（放在 Tailwind 後面） -->
  <style> 
/* =========================
   Global / Base
========================= */
html, body{
  overflow-x: hidden;
}

/* =========================
   Navigation
========================= */
nav.nav-bar{
  width: 100%;
  max-width: 720px;
  margin: 0 auto 16px;
  padding: 12px 16px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,.08);
  box-sizing: border-box;
}

#btn-learning, #btn-practice{
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 9999px;
  box-shadow: 0 4px 12px rgba(0,0,0,.06), inset 0 -2px 0 rgba(0,0,0,.03);
  font-weight: 900;
  letter-spacing: .2px;
  transition: transform .14s ease, box-shadow .14s ease, background-color .14s ease, color .14s ease;
}
#btn-learning:hover, #btn-practice:hover{ transform: translateY(-1px) }
#btn-learning:active, #btn-practice:active{ transform: translateY(0) scale(.98) }

@media (max-width: 480px){
  nav.nav-bar{ padding: 10px 12px; overflow: hidden; }
  .nav-inner{
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
  }
  #btn-learning, #btn-practice{
    width: 100%;
    font-size: 16px !important;
    line-height: 1.2;
    padding: 10px 12px !important;
    transform: none !important;
  }
}

/* =========================
   Addition Table（學習頁）
========================= */
#addition-table{
  width: 100%;
  border-collapse: collapse !Important;
  border: 1px solid #bfdbfe !important;
  border-radius: 6px !important;
  background: #eff6ff;
  box-shadow: 0 8px 20px rgba(30,64,175,.06);
  table-layout: fixed;
  font-size: clamp(14px, 3.4vw, 18px);
}
#addition-table th, #addition-table td{
  padding: 8px 8px;
  border-bottom: 1px solid #bfdbfe;
  text-align: center;
  white-space: nowrap;
}
#addition-table thead th{
  background:#dbeafe;
  color:#1e40af;
  font-weight:800;
}
#addition-table td:first-child{
  position: sticky;
  left: 0;
  background: #eaf2ff;
  color:#1d4ed8;
  font-weight:800;
}

@media (max-width: 480px){
  #page-learning .overflow-x-auto{
    margin-left: -10px;
    margin-right: -10px;
    padding: 0 4px;
  }
  #addition-table{ font-size: 14px !important; }
  #addition-table th, #addition-table td{ padding: 6px 6px; }
}

/* hover 高亮顏色（與 JS 相容） */
#addition-table th.bg-yellow-300, #addition-table td.bg-yellow-300 {
  background-color: #fcd34d !important;
  color: #111827 !important;
}
#addition-table th.bg-yellow-100, #addition-table td.bg-yellow-100 {
  background-color: #fef3c7 !important;
  color: #111827 !important;
}

/* =========================
   Practice：題目字級
========================= */
#question-box > p,
#question-box > div{
  font-size: clamp(28px, 6vw, 44px) !important;
}
@media (max-width: 480px){
  #question-box > p,
  #question-box > div{
    font-size: 32px !important;
  }
}

/* =========================
   Result Page（結果頁）
========================= */

/* 標題、說明、分數（維持較小、不影響表格與按鈕） */
#practice-result h1{
  font-size: clamp(18px, 5vw, 22px) !important; /* 練習結束！🎉 */
  line-height: 1.25;
  margin-bottom: 10px !important;
}
#practice-result > p:nth-of-type(1){
  font-size: clamp(14px, 4.2vw, 18px) !important; /* 你的最終得分是： */
  line-height: 1.5;
  margin-bottom: 8px !important;
}
#final-score{
  font-size: clamp(20px, 9vw, 28px) !important;  /* 10 分 */
  line-height: 1.1;
  padding: 10px 14px !important;
}

/* 行動按鈕：一行一顆，同字級 18px */
#btn-retry, #btn-reselect{
  font-size: 18px !important;
  line-height: 1.2;
}
#practice-result .actions{
  display: flex;
  flex-direction: column !important;
  gap: 12px;
  max-width: 420px;
  margin: 16px auto 0;
}
#practice-result .actions > button{
  width: 100%;
}

/* 題目回顧卡片與表格 */
#review-box{
  max-width: 100%;
  background: #ffffff;
  border-radius: 12px;         /* 圓角 */
  padding: 16px;               /* 桌機維持 16px 內距 */
}
#review-box table{
  table-layout: auto !important;
  width: 100% !important;
  margin: 0 auto;
}

/* 欄寬與對齊：第一欄較寬靠左，後兩欄置中，皆不換行 */
#review-box thead th:first-child,
#review-box tbody td:first-child{
  white-space: nowrap !important;
  width: 56% !important;
  text-align: left !important;
}
#review-box thead th:nth-child(2),
#review-box thead th:nth-child(3),
#review-box tbody td:nth-child(2),
#review-box tbody td:nth-child(3){
  text-align: center !important;
  white-space: nowrap !important;
  width: 22% !important;
}

/* 表頭字級：你要 18px（手機也固定 18px） */
#review-box thead th{
  font-size: 18px !important;
  line-height: 1.3;
  font-weight: 700;
}

/* 手機：不再貼邊，左右各 12px 安全距，內距 12px＋圓角保留 */
@media (max-width: 480px){
  #review-box{
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: calc(-50vw + 12px) !important;  /* 兩側各留 12px */
    margin-right: calc(-50vw + 12px) !important;
    width: calc(100vw - 24px) !important;        /* 視窗寬 - 24px */
    max-width: calc(100vw - 24px) !important;
    padding: 12px !important;                    /* 你要 12px 內距 */
    border-radius: 12px !important;              /* 圓角 */
    overflow: hidden;                             /* 讓圓角可視 */
  }
}

/* =========================
   Footer
========================= */
.site-footer{
  width: 100%;
  max-width: 720px;
  box-sizing: border-box;
  margin: 20px auto 0;
  padding: 14px 12px;
  text-align: center;
  color: #6b7280;
  font-size: 13.5px;
  border-top: 1px solid #e5e7eb;
  background: transparent;
}

/* 回顧表格最大寬度 540，置中 */
#review-box table{
  width: 100% !important;      /* 小螢幕可吃滿 */
  max-width: 540px !important; /* 大螢幕不超過 540 */
  margin-left: auto !important;
  margin-right: auto !important;
}

  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-pink-100 to-blue-100 flex flex-col items-center justify-start p-4">
  <!-- NAV -->
  <nav class="nav-bar">
    <div class="nav-inner flex flex-nowrap justify-center items-center gap-3 sm:gap-4">
      <button id="btn-learning"
        class="px-4 py-2 sm:px-6 sm:py-3 rounded-full text-base sm:text-lg font-bold bg-purple-500 text-white shadow-md">
        ➕ 學習加法
      </button>
      <button id="btn-practice"
        class="px-4 py-2 sm:px-6 sm:py-3 rounded-full text-base sm:text-lg font-bold bg-green-200 text-green-800 hover:bg-green-300">
        📝 練習挑戰
      </button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="w-full max-w-5xl p-2 md:p-4"><!-- 放大主容器，回顧更寬 -->
    <!-- Learning Page -->
    <section id="page-learning" class="text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 mb-6 drop-shadow-md">加法表 💖</h1>
      <div class="overflow-x-auto">
        <table id="addition-table" class="text-sm sm:text-base md:text-lg"></table>
      </div>
    </section>

    <!-- Practice Page -->
    <section id="page-practice" class="text-center hidden">
      <div id="practice-select" class="text-center p-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-green-600 mb-6 drop-shadow-md">加減法大挑戰 🌟</h1>

        <div class="flex flex-col gap-3 max-w-3xl mx-auto mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
            <button data-mode="addition18"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-indigo-200 text-indigo-800 hover:bg-indigo-300">
              ➕ 18以內加法
            </button>
            <button data-mode="subtraction18"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-rose-200 text-rose-800 hover:bg-rose-300">
              ➖ 18以內減法
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
            <button data-mode="twoDigitAddition"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-amber-200 text-amber-800 hover:bg-amber-300">
              🔢 二位數加法
            </button>
            <button data-mode="twoDigitSubtraction"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-cyan-200 text-cyan-800 hover:bg-cyan-300">
              📊 二位數減法
            </button>
          </div>

          <div class="flex justify-center w-full">
            <button data-mode="mixed"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md w-full sm:w-1/2 md:w-1/3 lg:w-1/4 bg-teal-200 text-teal-800 hover:bg-teal-300"
              style="max-width:300px">
              🔀 綜合練習
            </button>
          </div>
        </div>

        <button id="btn-start"
          class="px-8 py-4 rounded-full text-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg bg-gray-300 text-gray-600 cursor-not-allowed"
          disabled>
          開始練習！🚀
        </button>
      </div>

      <div id="practice-play" class="hidden text-center p-4">
        <h1 id="practice-title" class="text-4xl md:text-5xl font-extrabold text-purple-600 mb-4 drop-shadow-md">加減法練習</h1>
        <div class="text-2xl md:text-3xl font-bold text-gray-700 mb-2">
          得分: <span id="score" class="text-green-600">0</span> / 100
        </div>
        <div class="text-xl md:text-2xl text-gray-600 mb-6">題目 <span id="q-index">1</span> / 10</div>

        <div id="question-box" class="bg-yellow-100 p-6 rounded-3xl shadow-xl inline-block mb-6 transition-transform duration-300 transform scale-105"></div>

        <div id="options" class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-4"></div>

        <p id="feedback" class="text-2xl md:text-3xl font-bold mt-4"></p>
      </div>

      <div id="practice-result" class="hidden text-center p-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-teal-600 mb-6 drop-shadow-md">練習結束！🎉</h1>
        <p class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">你的最終得分是：</p>
        <p id="final-score" class="text-5xl md:text-6xl font-extrabold text-teal-600 bg-teal-50 p-6 rounded-full inline-block shadow-lg animate-bounce mb-2">0 分</p>

        <h2 class="text-lg font-bold text-blue-600 mt-0 mb-2 drop-shadow-md">題目回顧</h2>

        <div id="review-box" class="bg-white rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto mx-auto">
          <table class="min-w-full text-left text-lg">
            <thead>
              <tr class="bg-blue-100 text-blue-800">
                <th class="py-2 px-3 border-b border-blue-200">題目</th>
                <th class="py-2 px-3 border-b border-blue-200">你的答案</th>
                <th class="py-2 px-3 border-b border-blue-200">正確答案</th>
              </tr>
            </thead>
            <tbody id="review-body"></tbody>
          </table>
        </div>

        <!-- 一行一顆按鈕（同字級） -->
        <div class="actions mt-6">
          <button id="btn-reselect"
            class="px-8 py-4 rounded-full text-xl font-bold bg-orange-500 text-white hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
            重新選擇練習 🔄
          </button>
          <button id="btn-retry"
            class="px-8 py-4 rounded-full text-xl font-bold bg-purple-500 text-white hover:bg-purple-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
            再玩一次！
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- 版權 -->
  <footer class="site-footer">© 2025 Christina Yu. All rights reserved.</footer>

  <!-- 行為腳本 -->
  <script>
    // ---------- Global state ----------
    let currentPage = 'learning';
    let selectedMode = null;
    let score = 0;
    let qIndex = 0;
    let currentQuestion = null;
    let options = [];
    let questionHistory = [];
    let selectedAnswer = null;
    let isCorrectAnswer = null;

    const synth = new Tone.Synth().toDestination();
    async function initializeAudioContext() {
      if (Tone.context.state !== 'running') await Tone.start();
    }

    const byId = (id) => document.getElementById(id);
    const btnLearning = byId('btn-learning');
    const btnPractice = byId('btn-practice');
    const pageLearning = byId('page-learning');
    const pagePractice = byId('page-practice');

    function setNavStyles() {
      if (currentPage === 'learning') {
        btnLearning.classList.add('bg-purple-500','text-white','shadow-md');
        btnLearning.classList.remove('bg-purple-200','text-purple-800','hover:bg-purple-300');
        btnPractice.classList.add('bg-green-200','text-green-800','hover:bg-green-300');
        btnPractice.classList.remove('bg-green-500','text-white','shadow-md');
      } else {
        btnPractice.classList.add('bg-green-500','text-white','shadow-md');
        btnPractice.classList.remove('bg-green-200','text-green-800','hover:bg-green-300');
        btnLearning.classList.add('bg-purple-200','text-purple-800','hover:bg-purple-300');
        btnLearning.classList.remove('bg-purple-500','text-white','shadow-md');
      }
    }

    btnLearning.addEventListener('click', async () => {
      await initializeAudioContext();
      currentPage = 'learning';
      pageLearning.classList.remove('hidden');
      pagePractice.classList.add('hidden');
      setNavStyles();
    });

    btnPractice.addEventListener('click', async () => {
      await initializeAudioContext();
      currentPage = 'practice';
      pageLearning.classList.add('hidden');
      pagePractice.classList.remove('hidden');
      setNavStyles();
    });

    // ---- Addition table ----
    function buildAdditionTable(n = 10) {
      const tbl = byId('addition-table');
      tbl.innerHTML = '';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      const th0 = document.createElement('th');
      th0.textContent = '+';
      trh.appendChild(th0);

      for (let c = 1; c <= n; c++) {
        const th = document.createElement('th');
        th.textContent = c;
        th.dataset.col = c;
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      for (let r = 1; r <= n; r++) {
        const tr = document.createElement('tr');
        const tdRow = document.createElement('td');
        tdRow.textContent = r;
        tdRow.dataset.rowHeader = r;
        tr.appendChild(tdRow);

        for (let c = 1; c <= n; c++) {
          const td = document.createElement('td');
          td.textContent = r + c;
          td.dataset.row = r;
          td.dataset.col = c;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tbl.appendChild(thead);
      tbl.appendChild(tbody);

      // Hover highlight：列/欄淡黃 + 表頭/最左欄深黃
      tbl.addEventListener('mouseover', (e) => {
        const cell = e.target.closest('td');
        if (!cell || !cell.dataset.row) return;
        const r = Number(cell.dataset.row);
        const c = Number(cell.dataset.col);

        // 表頭與最左欄：深黃
        tbl.querySelectorAll(`[data-row-header="${r}"]`).forEach(el => el.classList.add('bg-yellow-300'));
        tbl.querySelectorAll(`th[data-col="${c}"]`).forEach(el => el.classList.add('bg-yellow-300'));
        // 該列與該欄：淡黃
        tbl.querySelectorAll(`td[data-row="${r}"], td[data-col="${c}"]`).forEach(el => el.classList.add('bg-yellow-100'));
      });

      tbl.addEventListener('mouseout', () => {
        tbl.querySelectorAll('.bg-yellow-100').forEach(el => el.classList.remove('bg-yellow-100'));
        tbl.querySelectorAll('.bg-yellow-300').forEach(el => el.classList.remove('bg-yellow-300'));
      });
    }

    // ---- Practice logic ----
    const practiceSelect = byId('practice-select');
    const practicePlay = byId('practice-play');
    const practiceResult = byId('practice-result');
    const modeButtons = document.querySelectorAll('.mode-btn');
    const btnStart = byId('btn-start');

    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        modeButtons.forEach(b => {
          b.classList.remove('bg-indigo-500','text-white','ring-4','ring-indigo-300',
                             'bg-rose-500','ring-rose-300',
                             'bg-amber-500','ring-amber-300',
                             'bg-cyan-500','ring-cyan-300',
                             'bg-teal-500','ring-teal-300');
        });
        selectedMode = btn.dataset.mode;
        if (selectedMode === 'addition18') btn.classList.add('bg-indigo-500','text-white','ring-4','ring-indigo-300');
        if (selectedMode === 'subtraction18') btn.classList.add('bg-rose-500','text-white','ring-4','ring-rose-300');
        if (selectedMode === 'twoDigitAddition') btn.classList.add('bg-amber-500','text-white','ring-4','ring-amber-300');
        if (selectedMode === 'twoDigitSubtraction') btn.classList.add('bg-cyan-500','text-white','ring-4','ring-cyan-300');
        if (selectedMode === 'mixed') btn.classList.add('bg-teal-500','text-white','ring-4','ring-teal-300');

        btnStart.disabled = false;
        btnStart.classList.remove('bg-gray-300','text-gray-600','cursor-not-allowed');
        btnStart.classList.add('bg-blue-500','text-white','hover:bg-blue-600');
      });
    });

    btnStart.addEventListener('click', () => startRound());

    function updatePracticeTitle() {
      const map = {
        addition18: '18以內加法練習',
        subtraction18: '18以內減法練習',
        twoDigitAddition: '二位數加法練習',
        twoDigitSubtraction: '二位數減法練習',
        mixed: '綜合加減法練習'
      };
      byId('practice-title').textContent = map[selectedMode] || '加減法練習';
    }

    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }
    async function playCorrect(){
      if (Tone.context.state === 'running'){
        synth.triggerAttackRelease("C5","8n"); await delay(100);
        synth.triggerAttackRelease("G5","8n"); await delay(200);
        synth.triggerAttackRelease("C5","8n"); await delay(100);
        synth.triggerAttackRelease("G5","8n");
      }
    }
    async function playIncorrect(){
      if (Tone.context.state === 'running'){
        synth.triggerAttackRelease("F4","8n"); await delay(250);
        synth.triggerAttackRelease("C4","8n");
      }
    }

    function getRandomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function makeQuestion(mode){
      let num1, num2, operator, answer;
      if (mode === 'addition18'){ num1=getRandomInt(1,9); num2=getRandomInt(1,9); operator='+'; answer=num1+num2; }
      else if (mode === 'subtraction18'){ num1=getRandomInt(1,18); num2=getRandomInt(1,num1); operator='-'; answer=num1-num2; }
      else if (mode === 'twoDigitAddition'){ num1=getRandomInt(10,99); num2=getRandomInt(10,99); operator='+'; answer=num1+num2; }
      else if (mode === 'twoDigitSubtraction'){ num1=getRandomInt(10,99); num2=getRandomInt(10,num1); operator='-'; answer=num1-num2; }
      else { const modes=['addition18','subtraction18','twoDigitAddition','twoDigitSubtraction']; return makeQuestion(modes[Math.floor(Math.random()*modes.length)]); }

      const set = new Set([answer]);
      if (mode === 'twoDigitAddition' || mode === 'twoDigitSubtraction'){
        const potentials=[answer+10, answer-10]; const unit = answer%10; let added=false;
        for (const w of potentials){ if (w>=0 && w<=199 && w!==answer && w%10===unit && !set.has(w)){ set.add(w); added=true; break; } }
        if (!added){
          for (let i=0;i<5;i++){ let off=(getRandomInt(1,3)*10)*(Math.random()<0.5?1:-1);
            const w=answer+off; if (w>=0 && w<=199 && w!==answer && w%10===unit && !set.has(w)){ set.add(w); break; } }
        }
      }
      while (set.size<4){
        let range=5; if (answer>50) range=15; else if (answer<10) range=3;
        let off=getRandomInt(-range,range); if (off===0) off=(Math.random()<0.5?1:-1)*getRandomInt(1,2);
        const w=answer+off; if (w>=0 && w!==answer && !set.has(w)) set.add(w);
      }
      const opts = Array.from(set).sort(()=>Math.random()-0.5);
      return { num1,num2,operator,answer,options:opts };
    }

    function renderQuestion(){
      byId('score').textContent = String(score);
      byId('q-index').textContent = String(qIndex+1);
      const qBox = byId('question-box'); const optsBox = byId('options');
      const feedback = byId('feedback'); qBox.innerHTML='';

      if (selectedMode==='twoDigitAddition' || selectedMode==='twoDigitSubtraction'){
        const wrap=document.createElement('div');
        wrap.className='flex flex-col items-end text-yellow-800 font-extrabold text-5xl md:text-6xl mx-auto relative min-w-[150px]';
        const top=document.createElement('div'); top.className='w-full text-right'; top.textContent=currentQuestion.num1;
        const mid=document.createElement('div'); mid.className='flex items-baseline w-full justify-end relative';
        const op=document.createElement('span'); op.className='absolute left-0 text-4xl md:text-5xl -mt-1'; op.textContent=currentQuestion.operator;
        const bottom=document.createElement('span'); bottom.className='flex-grow text-right'; bottom.textContent=currentQuestion.num2;
        const line=document.createElement('div'); line.className='w-full border-t-4 border-yellow-800 mt-2 pt-2 text-right'; line.textContent='?';
        mid.appendChild(op); mid.appendChild(bottom); wrap.appendChild(top); wrap.appendChild(mid); wrap.appendChild(line); qBox.appendChild(wrap);
      }else{
        const p=document.createElement('p'); p.className='text-5xl md:text-6xl font-extrabold text-yellow-800';
        p.textContent=`${currentQuestion.num1} ${currentQuestion.operator} ${currentQuestion.num2} = ?`; qBox.appendChild(p);
      }

      optsBox.innerHTML=''; currentQuestion.options.forEach(opt=>{
        const btn=document.createElement('button');
        btn.className='opt-btn p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform hover:scale-105 shadow-md bg-indigo-300 text-indigo-900 hover:bg-indigo-400';
        btn.textContent=opt; btn.dataset.value=opt; btn.disabled=false; optsBox.appendChild(btn);
      });

      feedback.textContent=''; feedback.className='text-2xl md:text-3xl font-bold mt-4';
    }

    function generateQuestion(){
      const q = makeQuestion(selectedMode);
      currentQuestion = { num1:q.num1, num2:q.num2, operator:q.operator, answer:q.answer };
      options = q.options.slice(); currentQuestion.options = options;
      selectedAnswer = null; isCorrectAnswer = null; renderQuestion();
    }

    // 正確亮綠、錯誤亮紅，其他變淡
    byId('options').addEventListener('click', async (e)=>{
      const btn = e.target.closest('.opt-btn'); if(!btn) return;
      if (selectedAnswer !== null) return;

      selectedAnswer = Number(btn.dataset.value);
      const correct = selectedAnswer === currentQuestion.answer;
      isCorrectAnswer = correct;

      document.querySelectorAll('.opt-btn').forEach(b=>{
        const val = Number(b.dataset.value);
        b.disabled = true;
        b.classList.remove('bg-indigo-300','text-indigo-900','hover:bg-indigo-400','bg-green-500','bg-red-500','opacity-50','cursor-not-allowed','scale-110','scale-105','shadow-lg');
        if (val === currentQuestion.answer){
          b.classList.add('bg-green-500','text-white','scale-110','shadow-lg');
        }else if (val === selectedAnswer && !correct){
          b.classList.add('bg-red-500','text-white','scale-105','shadow-lg');
        }else{
          b.classList.add('bg-indigo-300','text-indigo-900','opacity-50','cursor-not-allowed');
        }
      });

      const fb = byId('feedback');
      if (correct){ score += 10; fb.textContent='✅ 答對了！'; await playCorrect(); }
      else { fb.textContent=`❌ 答錯了，正確的是 ${currentQuestion.answer}`; await playIncorrect(); }

      questionHistory.push({ question:`${currentQuestion.num1} ${currentQuestion.operator} ${currentQuestion.num2}`, correctAnswer:currentQuestion.answer, userAnswer:selectedAnswer, isCorrect:correct });

      setTimeout(()=>{ if (qIndex<9){ qIndex+=1; generateQuestion(); } else { showResult(); } }, 1500);
    });

    function startRound(){
      score=0; qIndex=0; questionHistory=[]; selectedAnswer=null; isCorrectAnswer=null;
      practiceSelect.classList.add('hidden'); practiceResult.classList.add('hidden'); practicePlay.classList.remove('hidden');
      updatePracticeTitle(); generateQuestion();
    }

    function showResult(){
      practicePlay.classList.add('hidden'); practiceResult.classList.remove('hidden');
      byId('final-score').textContent = `${score} 分`;
      const rb = byId('review-body'); rb.innerHTML='';
      questionHistory.forEach(item=>{
        const tr=document.createElement('tr');
        tr.className='border-b border-blue-50 last:border-b-0 hover:bg-blue-50 transition-colors duration-200';
        tr.innerHTML = `
          <td class="py-2 px-3 font-bold">${item.question}</td>
          <td class="py-2 px-3 font-semibold ${item.isCorrect?'text-green-600':'text-red-500'}">${item.userAnswer}</td>
          <td class="py-2 px-3 font-bold text-gray-700">${item.correctAnswer}</td>`;
        rb.appendChild(tr);
      });
      const map={ addition18:'再玩一次18以內加法！', subtraction18:'再玩一次18以內減法！', twoDigitAddition:'再玩一次二位數加法！', twoDigitSubtraction:'再玩一次二位數減法！', mixed:'再玩一次綜合練習！' };
      byId('btn-retry').textContent = map[selectedMode] || '再玩一次！';
    }

    byId('btn-reselect').addEventListener('click', ()=>{
      selectedMode=null;
      btnStart.disabled=true;
      btnStart.classList.add('bg-gray-300','text-gray-600','cursor-not-allowed');
      btnStart.classList.remove('bg-blue-500','text-white','hover:bg-blue-600');
      document.querySelectorAll('.mode-btn').forEach(b=>{
        b.classList.remove('bg-indigo-500','text-white','ring-4','ring-indigo-300','bg-rose-500','ring-rose-300','bg-amber-500','ring-amber-300','bg-cyan-500','ring-cyan-300','bg-teal-500','ring-teal-300');
      });
      practicePlay.classList.add('hidden'); practiceResult.classList.add('hidden'); practiceSelect.classList.remove('hidden');
    });
    byId('btn-retry').addEventListener('click', ()=> startRound());

    // Init
    buildAdditionTable(10);
    setNavStyles();
  </script>
</body>
</html>


