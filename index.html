<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åŠ æ³•è¡¨ & åŠ æ¸›æ³•ç·´ç¿’ï½œHTML5 ç‰ˆ</title>

  <!-- Tailwind (Play CDN) + safelist forå‹•æ…‹åˆ‡æ›çš„ class -->
  <script>
    window.tailwind = {};
    tailwind.config = {
      safelist: [
        // nav toggles
        'bg-purple-500','text-white','shadow-md','bg-purple-200','text-purple-800','hover:bg-purple-300',
        'bg-green-500','bg-green-200','text-green-800','hover:bg-green-300',
        // learning table highlights
        'bg-yellow-100','bg-yellow-300',
        // mode buttons (selected/unselected)
        'bg-indigo-500','ring-4','ring-indigo-300','bg-indigo-200','text-indigo-800','hover:bg-indigo-300',
        'bg-rose-500','ring-rose-300','bg-rose-200','text-rose-800','hover:bg-rose-300',
        'bg-amber-500','ring-amber-300','bg-amber-200','text-amber-800','hover:bg-amber-300',
        'bg-cyan-500','ring-cyan-300','bg-cyan-200','text-cyan-800','hover:bg-cyan-300',
        'bg-teal-500','ring-teal-300','bg-teal-200','text-teal-800','hover:bg-teal-300',
        // options state
        'bg-indigo-300','text-indigo-900','hover:bg-indigo-400','opacity-50','cursor-not-allowed',
        'bg-green-500','bg-red-500','scale-110','scale-105','shadow-lg',
        // result styling
        'bg-teal-50','text-teal-600','animate-bounce',
        // borders
        'border-yellow-800'
      ]
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
<style>
/* === å…©é¡†å°è¦½æŒ‰éˆ•ï¼ˆå­¸ç¿’ï¼ç·´ç¿’ï¼‰â€”å¤–è§€èˆ‡æ‰‹æ©Ÿç¸®å° === */
#btn-learning,
#btn-practice{
  font-weight: 900;
  letter-spacing: .2px;
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 9999px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
  transition: transform .14s ease, box-shadow .14s ease;
}
#btn-learning:hover,
#btn-practice:hover{ transform: translateY(-1px) }
#btn-learning:active,
#btn-practice:active{ transform: translateY(0) scale(.98) }

/* æ‰‹æ©Ÿï¼šå…©é¡†å›ºå®šåŒä¸€è¡Œã€ä¸æ²å‹•ï¼Œä¸¦ä¸”ç¸®å° */
@media (max-width: 480px){
  nav{
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
    justify-content: center;
  }
  #btn-learning,
  #btn-practice{
    width: 100%;
    padding: 10px 12px !important;  /* è“‹é Tailwind çš„ px/py */
    font-size: 16px !important;      /* è“‹é text-[14px]/text-lg */
    line-height: 1.2;
  }
}

/* === åŠ æ³•è¡¨é‚Šç•Œï¼ˆæ›´è²¼é‚Šã€é‚Šæ¡†ä¸€è‡´ã€æ‰‹æ©Ÿå­—é«”åˆ¥å¤ªå¤§ï¼‰ === */
#addition-table{
  border-collapse: collapse !important;
  border: 1px solid #bfdbfe !important; /* å’ŒåŸæœ¬è—é‚Šä¸€è‡´ */
  border-radius: 6px !important;
  box-shadow: 0 6px 16px rgba(30,64,175,.08);
}
#addition-table th,
#addition-table td{
  padding: 8px 8px;
  white-space: nowrap;
  text-align: center;
  border-bottom: 1px solid #bfdbfe;
}

/* æ‰‹æ©Ÿï¼šè¡¨æ ¼æ›´è²¼è¢å¹•é‚Šã€å­—é«”å†å°ä¸€é»ã€cell æ›´ç·Šæ¹Š */
@media (max-width: 480px){
  #page-learning .overflow-x-auto{
    margin-left: -10px;
    margin-right: -10px;
    padding: 0 4px;       /* å¹¾ä¹è²¼é½Šè¢å¹• */
  }
  #addition-table{
    font-size: 14px !important;
  }
  #addition-table th,
  #addition-table td{
    padding: 6px 6px;
  }
}
</style>

  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-100 to-blue-100 flex flex-col items-center justify-center p-4 font-inter">

  <!-- NAVï¼ˆæ‰‹æ©Ÿï¼šå­—ç´š/å…§è·ç¸®å° + å–®è¡Œã€ä¸æ²å‹•ï¼‰ -->
  <nav class="mb-6 p-2 bg-white rounded-2xl shadow-lg">
    <div class="flex flex-nowrap justify-center items-center gap-2 sm:gap-4">
      <button id="btn-learning"
        class="px-3 py-2 sm:px-6 sm:py-3 rounded-full text-[14px] leading-tight sm:text-lg font-bold whitespace-nowrap transition-all duration-300 hover:scale-105 bg-purple-500 text-white shadow-md">
        â• å­¸ç¿’åŠ æ³•
      </button>
      <button id="btn-practice"
        class="px-3 py-2 sm:px-6 sm:py-3 rounded-full text-[14px] leading-tight sm:text-lg font-bold whitespace-nowrap transition-all duration-300 hover:scale-105 bg-green-200 text-green-800 hover:bg-green-300">
        ğŸ“ ç·´ç¿’æŒ‘æˆ°
      </button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="w-full max-w-4xl p-2 md:p-4 transform transition-transform duration-500 ease-out">
    <!-- Learning Addition Page -->
    <section id="page-learning" class="text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 mb-8 drop-shadow-md">åŠ æ³•è¡¨ ğŸ’–</h1>
      <div class="overflow-x-auto">
        <table id="addition-table" class="w-full bg-blue-50 border border-blue-200 rounded-xl shadow-lg text-sm sm:text-base md:text-lg"></table>
      </div>
      <p class="mt-8 text-gray-600 text-lg">é€™å€‹è¡¨æ ¼å¯ä»¥å¹«åŠ©ä½ å¿«é€Ÿå­¸ç¿’åŠ æ³•ï¼</p>
    </section>

    <!-- Practice Page -->
    <section id="page-practice" class="text-center hidden">
      <div id="practice-select" class="text-center p-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-green-600 mb-6 drop-shadow-md">åŠ æ¸›æ³•å¤§æŒ‘æˆ° ğŸŒŸ</h1>

        <div class="flex flex-col gap-3 max-w-3xl mx-auto mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
            <button data-mode="addition18"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-indigo-200 text-indigo-800 hover:bg-indigo-300">
              â• 18ä»¥å…§åŠ æ³•
            </button>
            <button data-mode="subtraction18"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-rose-200 text-rose-800 hover:bg-rose-300">
              â– 18ä»¥å…§æ¸›æ³•
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
            <button data-mode="twoDigitAddition"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-amber-200 text-amber-800 hover:bg-amber-300">
              ğŸ”¢ äºŒä½æ•¸åŠ æ³•
            </button>
            <button data-mode="twoDigitSubtraction"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-cyan-200 text-cyan-800 hover:bg-cyan-300">
              ğŸ“Š äºŒä½æ•¸æ¸›æ³•
            </button>
          </div>

          <div class="flex justify-center w-full">
            <button data-mode="mixed"
              class="mode-btn p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md w-full sm:w-1/2 md:w-1/3 lg:w-1/4 bg-teal-200 text-teal-800 hover:bg-teal-300"
              style="max-width:300px">
              ğŸ”€ ç¶œåˆç·´ç¿’
            </button>
          </div>
        </div>

        <button id="btn-start"
          class="px-8 py-4 rounded-full text-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg bg-gray-300 text-gray-600 cursor-not-allowed"
          disabled>
          é–‹å§‹ç·´ç¿’ï¼ğŸš€
        </button>
      </div>

      <div id="practice-play" class="hidden text-center p-4">
        <h1 id="practice-title" class="text-4xl md:text-5xl font-extrabold text-purple-600 mb-4 drop-shadow-md">åŠ æ¸›æ³•ç·´ç¿’ âœ¨</h1>
        <div class="text-2xl md:text-3xl font-bold text-gray-700 mb-2">
          å¾—åˆ†: <span id="score" class="text-green-600">0</span> / 100
        </div>
        <div class="text-xl md:text-2xl text-gray-600 mb-6">é¡Œç›® <span id="q-index">1</span> / 10</div>

        <div id="question-box" class="bg-yellow-100 p-6 rounded-3xl shadow-xl inline-block mb-6 transition-transform duration-300 transform scale-105"></div>

        <div id="options" class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-4"></div>

        <p id="feedback" class="text-2xl md:text-3xl font-bold mt-4"></p>
      </div>

      <div id="practice-result" class="hidden text-center p-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-teal-600 mb-6 drop-shadow-md">ç·´ç¿’çµæŸï¼ğŸ‰</h1>
        <p class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">ä½ çš„æœ€çµ‚å¾—åˆ†æ˜¯ï¼š</p>
        <p id="final-score" class="text-5xl md:text-6xl font-extrabold text-teal-600 bg-teal-50 p-6 rounded-full inline-block shadow-lg animate-bounce mb-6">0 åˆ†</p>

        <h2 class="text-3xl font-bold text-blue-600 mt-6 mb-4 drop-shadow-md">é¡Œç›®å›é¡§</h2>
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto mx-auto max-w-xl">
          <table class="min-w-full text-left text-lg">
            <thead>
              <tr class="bg-blue-100 text-blue-800">
                <th class="py-2 px-3 border-b border-blue-200">é¡Œç›®</th>
                <th class="py-2 px-3 border-b border-blue-200">ä½ çš„ç­”æ¡ˆ</th>
                <th class="py-2 px-3 border-b border-blue-200">æ­£ç¢ºç­”æ¡ˆ</th>
              </tr>
            </thead>
            <tbody id="review-body"></tbody>
          </table>
        </div>

        <div class="mt-6 flex flex-col md:flex-row justify-center gap-4">
          <button id="btn-reselect"
            class="px-8 py-4 rounded-full text-2xl font-bold bg-orange-500 text-white hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
            é‡æ–°é¸æ“‡ç·´ç¿’ ğŸ”„
          </button>
          <button id="btn-retry"
            class="px-8 py-4 rounded-full text-2xl font-bold bg-purple-500 text-white hover:bg-purple-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
            å†ç©ä¸€æ¬¡ï¼âœ¨
          </button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Global state ----------
    let currentPage = 'learning';   // 'learning' | 'practice'
    let selectedMode = null;
    let score = 0;
    let qIndex = 0;                 // 0..9
    let currentQuestion = null;     // { num1, num2, operator, answer }
    let options = [];
    let questionHistory = [];
    let selectedAnswer = null;
    let isCorrectAnswer = null;

    // Tone synth
    const synth = new Tone.Synth().toDestination();
    async function initializeAudioContext() {
      if (Tone.context.state !== 'running') await Tone.start();
    }

    // ---------- Helpers ----------
    const byId = (id) => document.getElementById(id);
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    // ---------- Page switching ----------
    const btnLearning = byId('btn-learning');
    const btnPractice = byId('btn-practice');
    const pageLearning = byId('page-learning');
    const pagePractice = byId('page-practice');

    function setNavStyles() {
      if (currentPage === 'learning') {
        btnLearning.classList.add('bg-purple-500','text-white','shadow-md');
        btnLearning.classList.remove('bg-purple-200','text-purple-800','hover:bg-purple-300');
        btnPractice.classList.add('bg-green-200','text-green-800','hover:bg-green-300');
        btnPractice.classList.remove('bg-green-500','text-white','shadow-md');
      } else {
        btnPractice.classList.add('bg-green-500','text-white','shadow-md');
        btnPractice.classList.remove('bg-green-200','text-green-800','hover:bg-green-300');
        btnLearning.classList.add('bg-purple-200','text-purple-800','hover:bg-purple-300');
        btnLearning.classList.remove('bg-purple-500','text-white','shadow-md');
      }
    }

    btnLearning.addEventListener('click', async () => {
      await initializeAudioContext();
      currentPage = 'learning';
      show(pageLearning); hide(pagePractice);
      setNavStyles();
    });

    btnPractice.addEventListener('click', async () => {
      await initializeAudioContext();
      currentPage = 'practice';
      hide(pageLearning); show(pagePractice);
      setNavStyles();
    });

    // ---------- Build addition table with hover highlight ----------
    function buildAdditionTable(n = 10) {
      const tbl = byId('addition-table');
      tbl.innerHTML = '';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      trh.className = 'bg-blue-200 text-blue-800';

      const th0 = document.createElement('th');
      th0.className = 'py-1 px-1 border-b border-blue-200 font-bold rounded-none';
      th0.textContent = '+';
      trh.appendChild(th0);

      for (let c = 1; c <= n; c++) {
        const th = document.createElement('th');
        th.className = 'py-1 px-1 border-b border-blue-200 font-bold rounded-none';
        th.textContent = c;
        th.dataset.col = c;
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');

      for (let r = 1; r <= n; r++) {
        const tr = document.createElement('tr');
        tr.className = 'transition-colors duration-200';

        const tdRow = document.createElement('td');
        tdRow.className = 'py-1 px-1 border-b border-blue-200 text-blue-700 font-bold bg-blue-100';
        tdRow.textContent = r;
        tdRow.dataset.rowHeader = r;
        tr.appendChild(tdRow);

        for (let c = 1; c <= n; c++) {
          const td = document.createElement('td');
          td.className = 'py-1 px-1 border-b border-blue-200 text-gray-700';
          td.textContent = r + c;
          td.dataset.row = r;
          td.dataset.col = c;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      tbl.appendChild(thead);
      tbl.appendChild(tbody);

      // Hover handling
      tbl.addEventListener('mouseover', (e) => {
        const cell = e.target.closest('td');
        if (!cell || !cell.dataset.row) return;
        const r = Number(cell.dataset.row);
        const c = Number(cell.dataset.col);

        tbl.querySelectorAll(`[data-row-header="${r}"]`).forEach(el => el.classList.add('bg-yellow-300'));
        tbl.querySelectorAll(`th[data-col="${c}"]`).forEach(el => el.classList.add('bg-yellow-300'));
        tbl.querySelectorAll(`td[data-row="${r}"], td[data-col="${c}"]`).forEach(el => el.classList.add('bg-yellow-100'));
      });

      tbl.addEventListener('mouseout', () => {
        tbl.querySelectorAll('.bg-yellow-100').forEach(el => el.classList.remove('bg-yellow-100'));
        tbl.querySelectorAll('.bg-yellow-300').forEach(el => el.classList.remove('bg-yellow-300'));
      });
    }

    // ---------- Practice logic ----------
    const practiceSelect = byId('practice-select');
    const practicePlay = byId('practice-play');
    const practiceResult = byId('practice-result');

    const modeButtons = document.querySelectorAll('.mode-btn');
    const btnStart = byId('btn-start');

    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // clear chosen styles
        modeButtons.forEach(b => {
          b.classList.remove('bg-indigo-500','text-white','ring-4','ring-indigo-300');
          b.classList.remove('bg-rose-500','text-white','ring-4','ring-rose-300');
          b.classList.remove('bg-amber-500','text-white','ring-4','ring-amber-300');
          b.classList.remove('bg-cyan-500','text-white','ring-4','ring-cyan-300');
          b.classList.remove('bg-teal-500','text-white','ring-4','ring-teal-300');
        });

        selectedMode = btn.dataset.mode;
        if (selectedMode === 'addition18') btn.classList.add('bg-indigo-500','text-white','ring-4','ring-indigo-300');
        if (selectedMode === 'subtraction18') btn.classList.add('bg-rose-500','text-white','ring-4','ring-rose-300');
        if (selectedMode === 'twoDigitAddition') btn.classList.add('bg-amber-500','text-white','ring-4','ring-amber-300');
        if (selectedMode === 'twoDigitSubtraction') btn.classList.add('bg-cyan-500','text-white','ring-4','ring-cyan-300');
        if (selectedMode === 'mixed') btn.classList.add('bg-teal-500','text-white','ring-4','ring-teal-300');

        btnStart.disabled = false;
        btnStart.classList.remove('bg-gray-300','text-gray-600','cursor-not-allowed');
        btnStart.classList.add('bg-blue-500','text-white','hover:bg-blue-600');
      });
    });

    btnStart.addEventListener('click', () => startRound());

    function updatePracticeTitle() {
      const title = byId('practice-title');
      const map = {
        addition18: '18ä»¥å…§åŠ æ³•ç·´ç¿’ âœ¨',
        subtraction18: '18ä»¥å…§æ¸›æ³•ç·´ç¿’ âœ¨',
        twoDigitAddition: 'äºŒä½æ•¸åŠ æ³•ç·´ç¿’ âœ¨',
        twoDigitSubtraction: 'äºŒä½æ•¸æ¸›æ³•ç·´ç¿’ âœ¨',
        mixed: 'ç¶œåˆåŠ æ¸›æ³•ç·´ç¿’ âœ¨'
      };
      title.textContent = map[selectedMode] || 'åŠ æ¸›æ³•ç·´ç¿’ âœ¨';
    }

    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function playCorrect() {
      if (Tone.context.state === 'running') {
        synth.triggerAttackRelease("C5", "8n");
        await delay(100);
        synth.triggerAttackRelease("G5", "8n");
        await delay(200);
        synth.triggerAttackRelease("C5", "8n");
        await delay(100);
        synth.triggerAttackRelease("G5", "8n");
      }
    }
    async function playIncorrect() {
      if (Tone.context.state === 'running') {
        synth.triggerAttackRelease("F4", "8n");
        await delay(250);
        synth.triggerAttackRelease("C4", "8n");
      }
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function makeQuestion(mode) {
      let num1, num2, operator, answer;

      if (mode === 'addition18') {
        num1 = getRandomInt(1, 9);
        num2 = getRandomInt(1, 9);
        operator = '+';
        answer = num1 + num2;
      } else if (mode === 'subtraction18') {
        num1 = getRandomInt(1, 18);
        num2 = getRandomInt(1, num1);
        operator = '-';
        answer = num1 - num2;
      } else if (mode === 'twoDigitAddition') {
        num1 = getRandomInt(10, 99);
        num2 = getRandomInt(10, 99);
        operator = '+';
        answer = num1 + num2;
      } else if (mode === 'twoDigitSubtraction') {
        num1 = getRandomInt(10, 99);
        num2 = getRandomInt(10, num1);
        operator = '-';
        answer = num1 - num2;
      } else { // mixed
        const modes = ['addition18','subtraction18','twoDigitAddition','twoDigitSubtraction'];
        return makeQuestion(modes[Math.floor(Math.random()*modes.length)]);
      }

      const set = new Set([answer]);

      if (mode === 'twoDigitAddition' || mode === 'twoDigitSubtraction') {
        const potentials = [answer + 10, answer - 10];
        const unit = answer % 10;
        let added = false;
        for (const w of potentials) {
          if (w >= 0 && w <= 199 && w !== answer && (w % 10) === unit && !set.has(w)) {
            set.add(w); added = true; break;
          }
        }
        if (!added) {
          for (let i = 0; i < 5; i++) {
            let off = (getRandomInt(1,3)*10) * (Math.random()<0.5 ? 1 : -1);
            const w = answer + off;
            if (w >= 0 && w <= 199 && w !== answer && (w % 10) === unit && !set.has(w)) {
              set.add(w); break;
            }
          }
        }
      }

      while (set.size < 4) {
        let range = 5;
        if (answer > 50) range = 15;
        else if (answer < 10) range = 3;
        let off = getRandomInt(-range, range);
        if (off === 0) off = (Math.random()<0.5?1:-1) * getRandomInt(1,2);
        const w = answer + off;
        if (w >= 0 && w !== answer && !set.has(w)) set.add(w);
      }

      const opts = Array.from(set).sort(() => Math.random() - 0.5);
      return { num1, num2, operator, answer, options: opts };
    }

    function renderQuestion() {
      const qBox = byId('question-box');
      const optsBox = byId('options');
      const feedback = byId('feedback');

      byId('score').textContent = String(score);
      byId('q-index').textContent = String(qIndex + 1);

      qBox.innerHTML = '';
      if (selectedMode === 'twoDigitAddition' || selectedMode === 'twoDigitSubtraction') {
        const wrap = document.createElement('div');
        wrap.className = 'flex flex-col items-end text-yellow-800 font-extrabold text-5xl md:text-6xl mx-auto relative min-w-[150px]';
        const top = document.createElement('div');
        top.className = 'w-full text-right';
        top.textContent = currentQuestion.num1;

        const mid = document.createElement('div');
        mid.className = 'flex items-baseline w-full justify-end relative';
        const op = document.createElement('span');
        op.className = 'absolute left-0 text-4xl md:text-5xl -mt-1';
        op.textContent = currentQuestion.operator;
        const bottomNum = document.createElement('span');
        bottomNum.className = 'flex-grow text-right';
        bottomNum.textContent = currentQuestion.num2;

        const line = document.createElement('div');
        line.className = 'w-full border-t-4 border-yellow-800 mt-2 pt-2 text-right';
        line.textContent = '?';

        mid.appendChild(op);
        mid.appendChild(bottomNum);
        wrap.appendChild(top);
        wrap.appendChild(mid);
        wrap.appendChild(line);
        qBox.appendChild(wrap);
      } else {
        const p = document.createElement('p');
        p.className = 'text-5xl md:text-6xl font-extrabold text-yellow-800';
        p.textContent = `${currentQuestion.num1} ${currentQuestion.operator} ${currentQuestion.num2} = ?`;
        qBox.appendChild(p);
      }

      // options
      optsBox.innerHTML = '';
      currentQuestion.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'opt-btn p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform hover:scale-105 shadow-md bg-indigo-300 text-indigo-900 hover:bg-indigo-400';
        btn.textContent = opt;
        btn.dataset.value = opt;
        btn.disabled = false;
        optsBox.appendChild(btn);
      });

      feedback.textContent = '';
      feedback.className = 'text-2xl md:text-3xl font-bold mt-4';
    }

    function generateQuestion() {
      const q = makeQuestion(selectedMode);
      currentQuestion = { num1: q.num1, num2: q.num2, operator: q.operator, answer: q.answer };
      options = q.options.slice();
      currentQuestion.options = options;
      selectedAnswer = null;
      isCorrectAnswer = null;
      renderQuestion();
    }

    // === ç­”æ¡ˆé»æ“Šï¼šå…ˆç§»é™¤åŸºåº•è‰²ï¼Œæ­£ç¢ºä¸€å¾‹äº®ã€Œç¶ è‰²ã€ ===
    byId('options').addEventListener('click', async (e) => {
      const btn = e.target.closest('.opt-btn');
      if (!btn) return;
      if (selectedAnswer !== null) return;

      selectedAnswer = Number(btn.dataset.value);
      const correct = selectedAnswer === currentQuestion.answer;
      isCorrectAnswer = correct;

      document.querySelectorAll('.opt-btn').forEach(b => {
        const val = Number(b.dataset.value);
        b.disabled = true;

        // æ¸…æ‰åŸºåº•ï¼†èˆŠç‹€æ…‹ï¼Œé¿å…ç´«è‰²/é›è‰²è¦†è“‹ç¶ è‰²
        b.classList.remove(
          'bg-indigo-300','text-indigo-900','hover:bg-indigo-400',
          'bg-green-500','bg-red-500','opacity-50','cursor-not-allowed',
          'scale-110','scale-105','shadow-lg'
        );

        if (val === currentQuestion.answer) {
          b.classList.add('bg-green-500','text-white','scale-110','shadow-lg');
        } else if (val === selectedAnswer && !correct) {
          b.classList.add('bg-red-500','text-white','scale-105','shadow-lg');
        } else {
          b.classList.add('bg-indigo-300','text-indigo-900','opacity-50','cursor-not-allowed');
        }
      });

      const fb = byId('feedback');
      if (correct) {
        score += 10;
        fb.textContent = 'âœ… ç­”å°äº†ï¼';
        await playCorrect();
      } else {
        fb.textContent = `âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentQuestion.answer}`;
        await playIncorrect();
      }

      questionHistory.push({
        question: `${currentQuestion.num1} ${currentQuestion.operator} ${currentQuestion.num2}`,
        correctAnswer: currentQuestion.answer,
        userAnswer: selectedAnswer,
        isCorrect: correct
      });

      setTimeout(() => {
        if (qIndex < 9) {
          qIndex += 1;
          generateQuestion();
        } else {
          showResult();
        }
      }, 1500);
    });

    function startRound() {
      score = 0;
      qIndex = 0;
      questionHistory = [];
      selectedAnswer = null;
      isCorrectAnswer = null;

      hide(practiceSelect);
      hide(practiceResult);
      show(practicePlay);

      updatePracticeTitle();
      generateQuestion();
    }

    function showResult() {
      hide(practicePlay);
      show(practiceResult);

      byId('final-score').textContent = `${score} åˆ†`;

      const rb = byId('review-body');
      rb.innerHTML = '';
      questionHistory.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-blue-50 last:border-b-0 hover:bg-blue-50 transition-colors duration-200';
        tr.innerHTML = `
          <td class="py-2 px-3 font-bold">${item.question}</td>
          <td class="py-2 px-3 font-semibold ${item.isCorrect ? 'text-green-600' : 'text-red-500'}">${item.userAnswer}</td>
          <td class="py-2 px-3 font-bold text-gray-700">${item.correctAnswer}</td>
        `;
        rb.appendChild(tr);
      });

      const map = {
        addition18: 'å†ç©ä¸€æ¬¡18ä»¥å…§åŠ æ³•ï¼âœ¨',
        subtraction18: 'å†ç©ä¸€æ¬¡18ä»¥å…§æ¸›æ³•ï¼âœ¨',
        twoDigitAddition: 'å†ç©ä¸€æ¬¡äºŒä½æ•¸åŠ æ³•ï¼ğŸ”¢',
        twoDigitSubtraction: 'å†ç©ä¸€æ¬¡äºŒä½æ•¸æ¸›æ³•ï¼ğŸ“Š',
        mixed: 'å†ç©ä¸€æ¬¡ç¶œåˆç·´ç¿’ï¼ğŸ²'
      };
      byId('btn-retry').textContent = map[selectedMode] || 'å†ç©ä¸€æ¬¡ï¼âœ¨';
    }

    byId('btn-reselect').addEventListener('click', () => {
      selectedMode = null;
      btnStart.disabled = true;
      btnStart.classList.add('bg-gray-300','text-gray-600','cursor-not-allowed');
      btnStart.classList.remove('bg-blue-500','text-white','hover:bg-blue-600');

      modeButtons.forEach(b => {
        b.classList.remove('bg-indigo-500','text-white','ring-4','ring-indigo-300',
                           'bg-rose-500','ring-rose-300',
                           'bg-amber-500','ring-amber-300',
                           'bg-cyan-500','ring-cyan-300',
                           'bg-teal-500','ring-teal-300');
      });

      hide(practicePlay);
      hide(practiceResult);
      show(practiceSelect);
    });

    byId('btn-retry').addEventListener('click', () => startRound());

    // ---------- Init ----------
    buildAdditionTable(10);
    setNavStyles();
  </script>
</body>
</html>

